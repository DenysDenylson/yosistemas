<!DOCTYPE html>
<html>
<head>
<script>
  var runCount = 0;
  function timerMethod() {
    runCount++;
    if(runCount > 15)
    {
      clearInterval(timerId);
    }
    if(@notificaciones.size >0)
    {
      s=document.getElementById("demo");
      s.src="/assets/not2.jpg";
      alert("I am an alert box!");
    }
  }
  var timerId = setInterval(timerMethod, 3000);
</script>
<script>
function changeSrc()
{
    if (@notificaciones.size == 0 || @notificaciones == nil)
    {
      s=document.getElementById("demo");
      s.src="/assets/not3.jpg";
    }
}
</script>
</head>
<nav class="navbar navbar-inverse" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse navbar-ex1-collapse">
    <ul class="nav navbar-nav pull-left nav-pills" >
      <li class="active"><a href="/">HOME</a></li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Temas <b class="caret"></b></a>
        <ul class="dropdown-menu">
        <%if  !current_user.nil? %>
          <li><a href="/temas/new/1">Crear Tema</a></li>
          <li><a href="/temas/show_mine">Mis Temas</a></li>
          <%end%>
          <li><a href="/temas">Ver Temas</a></li>
        </ul>
      </li>
      <%if  !current_user.nil? %>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Grupos <b class="caret"></b></a>
        <ul class="dropdown-menu">
          <%if current_user!=nil && current_user.rol == "Docente"%>
            <li><a href="/grupos/new">Crear Grupo</a></li>
          <%end%>
          <li><a href="/grupos">Ver grupos</a></li>
          <%if current_user!=nil && current_user.rol == "Docente"%>
            <li><a href="/grupos/mis_grupos">Mis grupos</a></li>
          <% end %>
        </ul>
      </li>
      <%end%>
      <%if  !current_user.nil? %>
      <li class="dropdown" onclick="changeSrc()">
        <%if @notificaciones!= nil && @notificaciones.size >0%>
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <img src="/assets/not2.jpg" height="25" width="30" id="demo">Notificaciones
            <b class="caret"></b>
          </a>
        <%else%>
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <img src="/assets/not3.jpg" height="25" width="30">Notificaciones
            <b class="caret"></b>
          </a>
        <%end%>
        <ul class="dropdown-menu">
          <%if((@notificaciones == nil || @notificaciones.size <= 0)&&( notificaciones_nueva_tarea == nil || notificaciones_nueva_tarea.size <= 0)) %>
            <li><a>Vacio </a> </li>
          <%else%>
            <% if @notificaciones != nil && @notificaciones.size > 0%>
              <% @notificaciones.each do |notificacion| %>
                <li>
                  <a href=<%="/temas/"+ TemaComentario.find(notificacion.tema_comentario_id).tema_id.to_s %>  >
                    <h4>
                      <%= "tema: "+Tema.find(TemaComentario.find(notificacion.tema_comentario_id).tema_id).titulo+" " %>
                    </h4>
                    &nbsp;&nbsp;&nbsp;<%= TemaComentario.find(notificacion.tema_comentario_id).cuerpo[0,20]+"..."%>
                  </a>
                </li>
              <%end%>
            <%end%>
            <% if notificaciones_nueva_tarea != nil && notificaciones_nueva_tarea.size > 0%>
              <% notificaciones_nueva_tarea.each do |notificacion2| %>
                <li>
                  <a href=<%="/tareas/"+ notificacion2.tarea_id.to_s %>  >
                    <h4>
                      <%= "Tarea: "+notificacion2.tarea.titulo %>
                    </h4>
                  </a>
                </li>
              <%end%>
            <%end%>
          <%end%>
        </ul>
      </li>
      <%end%>
      <%if current_user!=nil %>
      <li class="dropdown active">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><img src="/assets/message.png" width="21" title="Mensajes">
        <%mensajes_nuevos=Mensaje.where('para_usuario_id'=>current_user.id,'visto'=>false)%>
        <%if  mensajes_nuevos.size >0 %>
          <span class="badge"><%=mensajes_nuevos.size%></span>
        <%end%>
        </a>
        <ul class="dropdown-menu">          
           <li><a href="#myModal" role="button" class="btn" data-toggle="modal">Enviar Mensaje</a></li>                        
        <% mensajes_nuevos.each do |mensaje|%>          
            <li><a href="#" role="button" class="btn" data-toggle="modal"><%=Usuario.find(mensaje.de_usuario_id).nombre%></a></li>              
        <%end%>
        </ul>
      </li>
      <% end %>
    </ul>

    <%if current_user.nil?%>
      <form class="navbar-form navbar-right" method="get" action=<%=register_path%>  >
        <button type="submit" id="Registrarse" class="btn btn-primary" name="Registrarse">Registrarse</button>
      </form>
      <form class="navbar-form navbar-right" method="get" action=<%=forgot_password_path%>  >
        <button type="submit" class="btn btn-primary">Olvide mi contraseña</button>
      </form>
      <form class="navbar-form navbar-right" method="Post" action=<%=sessions_path%> >
        <div class="form-group">
          <%= text_field_tag :correo, params[:correo], :class=>'form-control', :placeholder=>'Correo o nombre de usuario', :size => 40 %>
        </div>
        <div class="form-group">
          <%= password_field_tag :contrasenia, params[:contrasenia], :class=>'form-control', :placeholder=>'Contraseña', :size => 40 %>
        </div>
        <button type="submit" class="btn btn-primary">Ingresar</button>
      </form>
    <%else%>
       <ul class="nav navbar-nav pull-right" >
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <%= image_tag avatar_tam_url(current_user,20) %><%=" "+current_user.correo%><b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li><a href=<%="/usuarios/"+current_user.id.to_s%>>Ver Perfil</a></li>
              <li><a href=<%=usuario_edit_path%> >Modificar Perfil</a></li>
              <li><a href=<%=update_password_path%> >Modificar Contraseña</a></li>
              <li><a href=<%=log_out_path%> >Salir</a></li>
            </ul>
          </li>
      </ul>
    <%end%>
  </div><!-- /.navbar-collapse -->
</nav>


<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h3 id="myModalLabel">Enviar Mensaje</h3>
        </div>
        <form method="post" action="/mensajes/enviar" class="bs-example form-horizontal">
          <div class="modal-body">
            <div class="row">
              <div class="col-lg-12">
                <fieldset>
                  <div class="form-group">
                    <label for="login" class="col-lg-2 control-label">Para:</label>
                    <div class="col-lg-9">
                    <input type="text" id="login" name="para" required placeholder="Usuario" class="form-control" data-provide="typeahead" data-items="4" data-source="<%=todos_los_usuarios%>">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="password" class="col-lg-2 control-label">Mensaje:</label>
                    <div class="col-lg-9">
                    <textarea name="mensaje" class="form-control" placeholder="Mensaje...." style="resize:none;" rows="9" maxlength="500" required></textarea>                    
                    </div>
                  </div>
                </fieldset>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Cancelar</button>
            <button type="submit" class="btn btn-primary">Enviar!</button>
          </div>
        </form>
      </div>
  </div>
</div>