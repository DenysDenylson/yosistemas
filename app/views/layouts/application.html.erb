<!DOCTYPE html>
<html>
<head>
  <title>Yosistemas</title>
  	<%= stylesheet_link_tag    "application", :media => "all" %>
  	<%= javascript_include_tag "application" %>
    <%= javascript_include_tag :defaults, "nested_form" %>
	<%= csrf_meta_tags %>
  <link rel="shortcut icon" href="/assets/favicon.png" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <script src="http://js.pusher.com/2.1/pusher.min.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    // Enable pusher logging - don't include this in production   
   
    Pusher.log = function(message) {
      if (window.console && window.console.log) {
        window.console.log(message);
      }
    };

    var pusher = new Pusher('5ea0579076700b536e21');
    var channel = pusher.subscribe('chat_channel');
    channel.bind('chat_event', function(data) {     
      document.getElementById('chat_conversacion').innerHTML=data.mensaje;             
    });      
    
  </script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/es_LA/all.js#xfbml=1&appId=522116067832259";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
  <div class="row">
    <div>
      <% flash.each do |name, msg| %>
        <div class="alert alert-info alert-dismissable">
          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">X</button>
          <%= content_tag :div, msg, :id => "flash_#{name}" %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="row" >
    <a class="navbar-brand" href="/"><img src="/assets/logo.png" /></a>
  </div>
  <div class="row">
    <%= render 'layouts/navigation' %>
  </div>
  <!-- Cuerpo de la pagina -->
  <div class="row">
    <!--Espacio Vacio del Lateral izquierdo.-->
    <div class="col-sm-1 col-md-1 col-lg-1"></div>
    <div class="col-sm-9 col-md-9 col-lg-9">
      <%= yield %>
    </div>
    <div class="col-sm-2 col-md-2 col-lg-2 hidden-phone">
      <ul class="list-group" style="height:100%; width:16.7%; position:fixed; top:184px; right:5px; background-color:white;">
      <% usuarios_conectados.each do |usuario| %>
        <li class="list-group-item" onclick="showChat('<%=usuario.nombre_usuario%>','<%=usuario.id%>');" style="cursor:pointer;" onmouseover="this.style.background='#F7F7F7';" onmouseout="this.style.background='white';">
        <a>
          <span class="badge">2</span>
          <b><%=usuario.nombre_usuario%></b>
        </a>
        </li>
      <%end%>
      </ul>
    </div>
  </div>
    <div id="chat_window" class="panel panel-primary hidden-phone fade" style="margin-bottom:0px;height:42%; width:18%; position:fixed; bottom:-3px; right:18%; background-color:white; ">
    <button onclick="closeChat();" style="margin-top:5px; margin-right:7px;" type="button" class="close">Ã—</button>
        <div class="panel-heading">
          <h3 class="panel-title" id="chat_name"></h3>
        </div>
        <div id="chat_conversacion" class="panel-body" style="height:100%; width:100%; overflow-y: auto;">          
        </div>
    </div>
      <!-- Pie de Pagina -->
    <div class="row">
        <%= render 'layouts/bootom_bar' %>
      </div>

    <script>
      function showChat(nombre_usuario,usuario_id)
      {
        document.getElementById('chat_name').innerText=nombre_usuario;
        $("#chat_window").addClass("in");        
         $.get('/usuarios/obtener_charla/'+usuario_id, function(response){          

            response=response.replace(/\&quot;/g, '"');
            var conversacion=JSON.parse(response)
            for(var i=0;i<conversacion.length;i++)
            {              
              if(conversacion[i].para_usuario_id!=usuario_id)
              {
                document.getElementById('chat_conversacion').innerHTML+="<div class='row'><div class='col-lg-12'><div class='pull-left pager' style='margin-bottom: 5px; margin-top: 0px;'><ul style='padding-left:0px;'><li><a style='color:black;'>"+conversacion[i].mensaje+"</a></li></ul></div></div></div>";
              }
              else
              {

                
                document.getElementById('chat_conversacion').innerHTML+="<div class='row'><div class='col-lg-12'><div class='pull-right pager' style='margin-bottom: 5px; margin-top: 0px;'><ul><li><a style='color:black;  background-color:#b81e0d;'>"+conversacion[i].mensaje+"</a></li></ul></div></div></div>"; 
              }    
            }            
          });
      }
      function closeChat()
      {
         $("#chat_window").removeClass("in");
      }
    </script>
</body>
</html>